<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>Rust Chat Demo</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body.login {background:url("lr_pic.jpg") center/cover fixed;}
  body.chat  {background:url("room_pic.jpg") center/cover fixed;}
  body::before{content:"";position:fixed;inset:0;backdrop-filter:blur(4px) brightness(.65);background:rgba(0,0,0,.4);z-index:-1;}
  #chat::-webkit-scrollbar{display:none}
  button.icon{font-size:1.25rem;line-height:1rem}
</style>
</head>
<body class="login flex min-h-screen text-white">

<!-- ===== å·¦å´æ¬„ï¼šæˆ¿é–“ + è¨­å®š ===== -->
<aside id="sidebar" class="hidden chat:flex flex-col w-44 bg-black/40 backdrop-blur p-4 space-y-4">
  <h3 class="font-semibold mb-2">Rooms</h3>
  <nav class="flex flex-col space-y-1">
    <button class="roomBtn text-left px-2 py-1 rounded hover:bg-white/20" onclick="switchRoom('lobby')"># lobby</button>
    <button class="roomBtn text-left px-2 py-1 rounded hover:bg-white/20" onclick="switchRoom('tech')"># tech</button>
    <button class="roomBtn text-left px-2 py-1 rounded hover:bg-white/20" onclick="switchRoom('random')"># random</button>
  </nav>
  <button onclick="openSettings()"
          class="mt-auto px-2 py-1 rounded bg-sky-600 hover:bg-sky-700 flex items-center">
    âš™ï¸ <span class="ml-1">Settings</span>
  </button>
</aside>

<!-- ===== ä¸»å€ ===== -->
<div class="flex-1 flex flex-col items-center pt-10">

<!-- === èƒŒæ™¯éŸ³æ¨‚ & è¨Šæ¯æç¤ºéŸ³ === -->
<audio id="bgm"  src="bgm.mp3"  preload="auto" loop></audio>
<audio id="ding" src="mes.wav"  preload="auto"></audio>
<script>
document.addEventListener("click",()=>{const a=bgm;if(a&&a.paused){a.volume=.3;a.play().catch(()=>{})}},{once:true});
</script>

<!-- ç™»å…¥ -->
<div id="auth" class="w-80 space-y-3 bg-white/10 rounded-xl p-6 shadow-lg">
  <h2 class="text-center text-2xl font-bold mb-2">ç™»å…¥èŠå¤©å®¤</h2>
  <input id="user" class="w-full p-2 rounded bg-white/80 text-gray-900" placeholder="ä½¿ç”¨è€…åç¨±">
  <input id="pass" type="password" class="w-full p-2 rounded bg-white/80 text-gray-900" placeholder="å¯†ç¢¼">
  <div class="flex items-center space-x-2">
    <select id="room" class="flex-1 p-2 rounded bg-white/80 text-gray-900">
      <option value="lobby">lobby</option><option value="tech">tech</option><option value="random">random</option>
    </select>
    <button class="flex-1 px-3 py-2 rounded bg-sky-600 hover:bg-sky-700" onclick="register()">Register</button>
    <button class="flex-1 px-3 py-2 rounded bg-emerald-600 hover:bg-emerald-700" onclick="login()">Login</button>
  </div>
</div>

<!-- èŠå¤©å®¤ -->
<div id="chatbox" class="hidden w-full max-w-xl mx-auto mt-6 space-y-3">
  <div class="flex justify-between items-center">
    <h2 class="text-xl font-bold">Room: <span id="roomName"></span></h2>
    <button onclick="logout()" class="px-3 py-1 rounded bg-red-600 hover:bg-red-700">Logout</button>
  </div>

  <div id="chat" class="h-80 overflow-y-auto px-3 py-2 bg-black/30 rounded-lg space-y-1 text-sm"></div>

  <!-- è¼¸å…¥ + ä¸Šå‚³ + éŒ„éŸ³ -->
  <div class="flex items-center space-x-2">
    <input id="file" type="file" class="hidden" accept="image/*,video/*,audio/*" onchange="sendFile(this.files[0])">
    <label for="file" class="icon cursor-pointer select-none">ğŸ“</label>
    <button class="icon select-none" id="recBtn"
            onmousedown="startRec()" onmouseup="stopRec()" ontouchstart="startRec()" ontouchend="stopRec()">ğŸ¤</button>
    <input id="msg" class="flex-1 p-2 rounded bg-white/90 text-gray-900"
           placeholder="è¼¸å…¥è¨Šæ¯å¾Œ Enter æˆ– Send" onkeydown="if(event.key==='Enter')sendMsg()">
    <button class="px-4 rounded bg-green-600 hover:bg-green-700" onclick="sendMsg()">Send</button>
  </div>

  <div class="bg-black/30 rounded-lg p-3">
    <h3 class="font-semibold mb-1">Online Users</h3>
    <ul id="userlist" class="text-xs space-y-0.5"></ul>
  </div>
</div>
</div><!-- /ä¸»å€ -->

<!-- === Settings Modal === -->
<div id="settings" class="hidden fixed inset-0 flex items-center justify-center bg-black/60">
  <div class="bg-white text-gray-900 rounded-xl p-6 w-80 space-y-4">
    <h2 class="text-lg font-semibold">Settings</h2>

    <div>
      <label class="block mb-1 font-medium">èƒŒæ™¯éŸ³é‡</label>
      <input id="bgVol" type="range" min="0" max="100" class="w-full" oninput="bgm.volume=this.value/100">
    </div>
    <div>
      <label class="block mb-1 font-medium">è¨Šæ¯éŸ³é‡</label>
      <input id="dingVol" type="range" min="0" max="100" class="w-full" oninput="ding.volume=this.value/100">
    </div>

    <div>
      <label class="block mb-1 font-medium">èƒŒæ™¯åœ–</label>
      <div class="flex space-x-2">
        <img src="lr_pic.jpg"   class="w-14 h-10 object-cover cursor-pointer" onclick="setBg('lr_pic.jpg')">
        <img src="room_pic.jpg" class="w-14 h-10 object-cover cursor-pointer" onclick="setBg('room_pic.jpg')">
        <input type="file" accept="image/*" onchange="setBgFile(this.files[0])">
      </div>
    </div>

    <button onclick="closeSettings()" class="w-full mt-2 py-1 rounded bg-sky-600 hover:bg-sky-700 text-white">Close</button>
  </div>
</div>

<script>
let token="", ws=null, myName="", curRoom="lobby";
const chatEl=chat, userListEl=userlist, dingEl=ding;

/* ========= å·¥å…· ========= */
const api=(p,b,j=true)=>fetch(p,{method:"POST",body:JSON.stringify(b),headers:{"Content-Type":"application/json"}})
      .then(r=>{if(!r.ok)throw r;return j?r.json():r});

/* ========= Auth ========= */
function register(){ if(!user.value||!pass.value) return alert("ç¼ºå°‘å¸³å¯†");
  api("/api/register",{username:user.value,password:pass.value},false)
     .then(()=>alert("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥")).catch(()=>alert("Register failed")); }

function login(){ if(!user.value||!pass.value) return alert("ç¼ºå°‘å¸³å¯†");
  api("/api/login",{username:user.value,password:pass.value})
    .then(j=>{
      token=j.token; myName=user.value.trim();
      switchRoom(room.value);
      document.body.classList.replace("login","chat");
      sidebar.classList.remove("hidden");
      auth.classList.add("hidden"); chatbox.classList.remove("hidden");
    }).catch(()=>alert("Login failed")); }

function logout(){
  ws?.close(); chatEl.innerHTML=""; userListEl.innerHTML="";
  document.body.classList.replace("chat","login");
  auth.classList.remove("hidden"); chatbox.classList.add("hidden");
  sidebar.classList.add("hidden");
}

/* ========= æˆ¿é–“åˆ‡æ› ========= */
function switchRoom(r){
  if(ws) ws.close();
  curRoom=r; roomName.textContent=r;
  [...document.querySelectorAll(".roomBtn")].forEach(b=>b.classList.remove("bg-white/20"));
  document.querySelector(`.roomBtn[onclick*="${r}"]`)?.classList.add("bg-white/20");
  connectWS(r);
}

/* ========= WebSocket ========= */
function connectWS(room){
  ws=new WebSocket(`${location.protocol==="https:"?"wss":"ws"}://${location.host}/ws/chat?room=${room}&token=${token}`);
  ws.onopen =()=>{chatEl.innerHTML=""; appendSys("å·²é€£ç·š")};
  ws.onclose=()=>appendSys("é€£ç·šä¸­æ–·");
  ws.onmessage=ev=>{
    let d;try{d=JSON.parse(ev.data);}catch{appendSys(ev.data);return;}
    if(d.type==="users") return renderUsers(d.list);
    if(d.type==="text")  return appendChat (d.name,d.text,true);
    if(d.type==="media") return appendMedia(d.name,d.url,d.mime,true);
  };
}

/* ========= é€æ–‡å­— ========= */
function sendMsg(){
  const txt=msg.value.trim(); if(!txt||!ws||ws.readyState!==1) return;
  ws.send(JSON.stringify({type:"text",text:txt})); msg.value="";
}

/* ========= ä¸Šå‚³æª”æ¡ˆ ========= */
async function sendFile(file){
  if(!file) return;
  const fd=new FormData(); fd.append("file",file);
  const r=await fetch("/api/upload",{method:"POST",body:fd});
  if(!r.ok) return alert("ä¸Šå‚³å¤±æ•—");
  const {url,mime}=await r.json();
  ws.send(JSON.stringify({type:"media",mime,url}));
}

/* ========= éŒ„éŸ³ ========= */
let rec, chunks=[];
async function startRec(){
  const s=await navigator.mediaDevices.getUserMedia({audio:true});
  rec=new MediaRecorder(s);
  rec.ondataavailable=e=>chunks.push(e.data);
  rec.onstop=()=>{ sendFile(new File([new Blob(chunks,{type:"audio/webm"})],"rec.webm",{type:"audio/webm"})); chunks=[]; };
  rec.start();
}
function stopRec(){ rec?.stop(); }

/* ========= UI ========= */
function appendSys(t){
  const d=document.createElement("div");
  d.className="text-center text-gray-400"; d.textContent="*** "+t;
  chatEl.appendChild(d); chatEl.scrollTop=chatEl.scrollHeight;
}
function appendChat(sender,text,fromSrv){
  const d=document.createElement("div"),me=sender===myName;
  d.className=me?"text-right":"text-left";
  d.innerHTML=me?`<span class="inline-block bg-green-500 text-white rounded-lg px-2 py-1 max-w-[70%] break-words">${text}</span>`
   :`<span class="text-indigo-300 mr-1">${sender}</span><span class="inline-block bg-indigo-500/30 backdrop-blur-sm rounded-lg px-2 py-1 max-w-[70%] break-words">${text}</span>`;
  chatEl.appendChild(d); chatEl.scrollTop=chatEl.scrollHeight;
  if(!me&&fromSrv) dingEl.play().catch(()=>{});
}
function appendMedia(sender,url,mime,fromSrv){
  const d=document.createElement("div"),me=sender===myName;
  let tag="";
  if(mime.startsWith("image/")) tag=`<img src="${url}" class="max-w-[70%] rounded-lg inline-block">`;
  else if(mime.startsWith("video/")) tag=`<video src="${url}" controls class="max-w-[70%] rounded-lg"></video>`;
  else if(mime.startsWith("audio/")) tag=`<audio src="${url}" controls></audio>`;
  else tag=`<a href="${url}" target="_blank" class="underline">${url.split('/').pop()}</a>`;
  d.className=me?"text-right":"text-left";
  d.innerHTML=me?tag:`<span class="text-indigo-300 mr-1">${sender}</span>${tag}`;
  chatEl.appendChild(d); chatEl.scrollTop=chatEl.scrollHeight;
  if(!me&&fromSrv) dingEl.play().catch(()=>{});
}
function renderUsers(arr){
  userListEl.innerHTML="";
  arr.forEach(n=>{const li=document.createElement("li");li.textContent=n;userListEl.appendChild(li);});
}

/* ========= Settings ========= */
function openSettings(){ settings.classList.remove("hidden"); bgVol.value=bgm.volume*100; dingVol.value=ding.volume*100;}
function closeSettings(){ settings.classList.add("hidden"); }
function setBg(img){ document.body.style.backgroundImage=`url(${img})`; }
function setBgFile(f){ if(!f)return; const url=URL.createObjectURL(f); setBg(url); }

</script>
</body>
</html>
